## 1. 数据库设计

1. 先介绍业务：抽奖系统作为 **营销活动平台中的一个环节**，承接着活动玩法、积分消耗、奖品发放等系统的纽带，帮助整个业务完成用户的活跃。
2. **后阐述领域**：作为一个战略设计的一环，战术实现上要尽可能做到 **职责隔离**，对应系统的具体实现上要拆分出；**活动、算法、规则、策略、用户、订单** 等领域。 
3. **引入表设计**：根据领域驱动中对各个模块的定义，设计数据库表，也就对应了 **活动表、抽奖策略配置表、准入规则引擎表、用户抽奖单记录表**、以及配合这些表数据结构运行的其他表，如：**记录用户的参与次数** 等。

![image-20230717232830916](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230717232830916.png)





## 分库分表

库、表都是根据 uid 来分：

```java
    @Around("aopPoint() && @annotation(dbRouter)")
    public void doRouter(String dbKeyAttr) {
        int size = dbRouterConfig.getDbCount() * dbRouterConfig.getTbCount();

        // 扰动函数：而为了让散列更加均匀，所以添加了扰动函数（参考 HashMap）
        int hash = dbKeyAttr.hashCode() ^ (dbKeyAttr.hashCode() >>> 16);
        // 得到数据库下标值，是整个表数量的值，下面还需要计算具体的库和表
        int idx = (size - 1) & hash;

        /*
        库表索引：相当于是把一个长条的桶，切割成段，对应分库分表中的库编号和表编号。
        若 6 TbCount，2 DbCount，则 size=12，那么 idx=4 路由到库 1，idx=7 路由到库 2。
        */
        int dbIdx = idx / dbRouterConfig.getTbCount() + 1;
        int tbIdx = idx - dbRouterConfig.getTbCount() * (dbIdx - 1);

        // 设置到 ThreadLocal 中
        DBContextHolder.setDBKey(String.format("%02d", dbIdx));
        DBContextHolder.setTBKey(String.format("%03d", tbIdx));

        logger.debug("数据库路由 dbIdx：{} tbIdx：{}",  dbIdx, tbIdx);
    }
```

## 2. 分布式事务如何解决？

![image-20230717202329500](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230717202329500.png)

https://wx.zsxq.com/dweb2/index/topic_detail/812855148222522



## 3. 幂等、超卖问题





## 流程

两个用户各参与一次抽奖，日志：

```java
c.r.l.i.facade.LotteryActivityBooth      : 抽奖，开始 uId：AruNi_Lu activityId：100001
 c.r.l.a.mq.producer.KafkaProducer        : 发送MQ消息(领取活动记录) topic：lottery_activity_partake bizId：AruNi_Lu message：{"activityId":100001,"stockCount":100,"stockSurplusCount":99,"uId":"AruNi_Lu"}
c.r.l.d.s.s.draw.impl.DrawExecImpl       : 执行抽奖策略 strategyId：10001，无库存排除奖品列表ID集合 awardList：["1"]
c.r.l.d.s.service.draw.AbstractDrawBase  : 执行策略抽奖完成【已中奖】，用户：AruNi_Lu 策略ID：10001 奖品ID：5 奖品名称：Book
c.r.l.a.mq.producer.KafkaProducer        : 发送MQ消息(中奖发货单) topic：lottery_invoice bizId：AruNi_Lu message：{"awardContent":"Code","awardId":"5","awardName":"Book","awardType":1,"orderId":1681316837146624000,"uId":"AruNi_Lu"}
c.r.l.a.p.d.i.ActivityDrawProcessImpl    : MQ 消息发送成功, 中奖物品发货单: InvoiceVO{uId='AruNi_Lu', orderId=1681316837146624000, awardId='5', awardType=1, awardName='Book', awardContent='Code', shippingAddress=null, extInfo='null'}
m.c.LotteryActivityPartakeRecordListener : 消费MQ消息，异步扣减活动库存 message：{"activityId":100001,"stockCount":100,"stockSurplusCount":99,"uId":"AruNi_Lu"}
c.r.l.i.facade.LotteryActivityBooth      : 抽奖，完成 uId：AruNi_Lu activityId：100001 drawRes：{"awardDTO":{"activityId":100001,"awardContent":"Code","awardId":"5","awardName":"Book","awardType":1,"userId":"AruNi_Lu"},"code":"0000","info":"成功"}
c.r.l.a.m.c.LotteryInvoiceListener       : 消费MQ消息，完成 topic：lottery_invoice bizId：AruNi_Lu 发奖结果：{"code":1,"info":"发奖成功","uId":"AruNi_Lu"}
c.r.l.i.facade.LotteryActivityBooth      : 活动部署页活动奖品信息查询开始 activityId：100001, activityName: null
c.r.l.i.facade.LotteryActivityBooth      : 活动部署页活动奖品信息查询完成 activityId：100001, activityName: 活动名, AwardDTOList: [{"awardId":"1","awardName":"IMac"},{"awardId":"2","awardName":"iphone"},{"awardId":"3","awardName":"ipad"},{"awardId":"4","awardName":"AirPods"},{"awardId":"5","awardName":"Book"},{"awardId":"6","awardName":"Keyboard"}]
c.r.l.i.facade.LotteryActivityBooth      : 抽奖，开始 uId：aruni-01 activityId：100001
c.r.l.a.mq.producer.KafkaProducer        : 发送MQ消息(领取活动记录) topic：lottery_activity_partake bizId：aruni-01 message：{"activityId":100001,"stockCount":100,"stockSurplusCount":99,"uId":"aruni-01"}
m.c.LotteryActivityPartakeRecordListener : 消费MQ消息，异步扣减活动库存 message：{"activityId":100001,"stockCount":100,"stockSurplusCount":99,"uId":"aruni-01"}
c.r.l.d.s.s.draw.impl.DrawExecImpl       : 执行抽奖策略 strategyId：10001，无库存排除奖品列表ID集合 awardList：["1"]
c.r.l.d.s.service.draw.AbstractDrawBase  : 执行策略抽奖完成【已中奖】，用户：aruni-01 策略ID：10001 奖品ID：2 奖品名称：iphone
c.r.l.a.mq.producer.KafkaProducer        : 发送MQ消息(中奖发货单) topic：lottery_invoice bizId：aruni-01 message：{"awardContent":"Code","awardId":"2","awardName":"iphone","awardType":1,"orderId":1681317804495732736,"uId":"aruni-01"}
c.r.l.i.facade.LotteryActivityBooth      : 抽奖，完成 uId：aruni-01 activityId：100001 drawRes：{"awardDTO":{"activityId":100001,"awardContent":"Code","awardId":"2","awardName":"iphone","awardType":1,"userId":"aruni-01"},"code":"0000","info":"成功"}
c.r.l.a.p.d.i.ActivityDrawProcessImpl    : MQ 消息发送成功, 中奖物品发货单: InvoiceVO{uId='aruni-01', orderId=1681317804495732736, awardId='2', awardType=1, awardName='iphone', awardContent='Code', shippingAddress=null, extInfo='null'}
c.r.l.a.m.c.LotteryInvoiceListener       : 消费MQ消息，完成 topic：lottery_invoice bizId：aruni-01 发奖结果：{"code":1,"info":"发奖成功","uId":"aruni-01"}
c.r.l.i.facade.LotteryActivityBooth      : 活动部署页活动奖品信息查询开始 activityId：100001, activityName: null
c.r.l.i.facade.LotteryActivityBooth      : 活动部署页活动奖品信息查询完成 activityId：100001, activityName: 活动名, AwardDTOList: [{"awardId":"1","awardName":"IMac"},{"awardId":"2","awardName":"iphone"},{"awardId":"3","awardName":"ipad"},{"awardId":"4","awardName":"AirPods"},{"awardId":"5","awardName":"Book"},{"awardId":"6","awardName":"Keyboard"}]
c.r.l.i.facade.LotteryActivityBooth      : 抽奖，开始 uId：aruni-02 activityId：100001
c.r.l.a.mq.producer.KafkaProducer        : 发送MQ消息(领取活动记录) topic：lottery_activity_partake bizId：aruni-02 message：{"activityId":100001,"stockCount":100,"stockSurplusCount":98,"uId":"aruni-02"}
m.c.LotteryActivityPartakeRecordListener : 消费MQ消息，异步扣减活动库存 message：{"activityId":100001,"stockCount":100,"stockSurplusCount":98,"uId":"aruni-02"}
c.r.l.d.s.s.draw.impl.DrawExecImpl       : 执行抽奖策略 strategyId：10001，无库存排除奖品列表ID集合 awardList：["1"]
c.r.l.d.s.service.draw.AbstractDrawBase  : 执行策略抽奖完成【已中奖】，用户：aruni-02 策略ID：10001 奖品ID：4 奖品名称：AirPods
c.r.l.a.mq.producer.KafkaProducer        : 发送MQ消息(中奖发货单) topic：lottery_invoice bizId：aruni-02 message：{"awardContent":"Code","awardId":"4","awardName":"AirPods","awardType":1,"orderId":1681317891942776832,"uId":"aruni-02"}
c.r.l.i.facade.LotteryActivityBooth      : 抽奖，完成 uId：aruni-02 activityId：100001 drawRes：{"awardDTO":{"activityId":100001,"awardContent":"Code","awardId":"4","awardName":"AirPods","awardType":1,"userId":"aruni-02"},"code":"0000","info":"成功"}
c.r.l.a.p.d.i.ActivityDrawProcessImpl    : MQ 消息发送成功, 中奖物品发货单: InvoiceVO{uId='aruni-02', orderId=1681317891942776832, awardId='4', awardType=1, awardName='AirPods', awardContent='Code', shippingAddress=null, extInfo='null'}
c.r.l.a.m.c.LotteryInvoiceListener       : 消费MQ消息，完成 topic：lottery_invoice bizId：aruni-02 发奖结果：{"code":1,"info":"发奖成功","uId":"aruni-02"}
```

数据库

活动表：

![image-20230718231924644](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230718231924644.png)

用户 1 相关数据：

- 用户参与抽奖策略导出表：

  ![image-20230718232211642](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230718232211642.png)

- 用户参与活动表：

  ![image-20230718232411599](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230718232411599.png)

- 用户参与活动次数表：

  ![image-20230718232802549](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230718232802549.png)

另一个用户与之类似。



redis 信息：

![image-20230718232856597](/Users/aarynlu/Library/Application Support/typora-user-images/image-20230718232856597.png)





