## 登录功能

因为登录成功后，需要将登录信息保存起来，方便用户进行以后的请求，所以需要考虑下面的问题。

分布式 session 问题：

传统的做法是直接查询 user 表获取 user 对象，然后存入 session 中，之后就可以根据 session 获取用户信息了。

这样的方案在分布式部署时会出现什么问题呢？

分布式部署意味着有多台服务器，而 session 是存储在服务器上的，那么如果我下次请求的服务器和我初始时请求的服务器不一样，就会因另一台服务器没有保存我的 session 而判定我为未登录状态。

![image-20221028171918119](https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281719174.png)

如何解决呢？

- 可以同步服务器的 session，但是这样不久浪费服务器资源了吗？
- 那要不，使用 cookie？cookie 以明文形式存储在客户端，不安全。

我们初步的解决方案是建一个登录凭证表，把用户信息保存到表中，有一个 ticket 字段，存放到 cookie 中，因为只是存放了一串随机字符串到 cookie，其他隐私信息都在表中，需要通过 ticket 访问表才能获取。

但是这样岂不是要额外建一张表来存放凭证信息，也有点浪费资源啊，而且每次都要查询数据库，效率也不高。



所以最终的解决方案是使用 **Redis**：

- 存储的 key 为 ticket，value 为字符串即可，因为要将登录凭证 LoginTicket 对象序列化后再存入 Redis；
- 同样，还是把 ticket 存放到 cookie 中；
- 由于 Redis 的性能高，而且设置了凭证的过期时间，过期的键会自动从 Redis 中删除，也不浪费资源；



现在在登录成功后，会生成一个带有用户信息和过期时间的登录凭证 LoginTicket 对象，保存到 Redis 中。

接着还要把生成的凭证 ticket 存入到客户端的 cookie 中，同样也要设置相同的过期时间。

之后客户端向服务器请求的时候就会带上 cookie。

那么我们从哪儿获取 cookie 呢？当然时要在用户请求页面前获取，这样才能在需要登录的请求处理前把用户的状态查询出来。

## 跨域问题

前端解决：https://cloud.tencent.com/developer/article/2381796

后端jie'juehttps://juejin.cn/post/6871583587062415367